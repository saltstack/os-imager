---
kind: pipeline
name: Lint AWS

platform:
  os: linux
  arch: amd64

steps:
- name: Arch
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-aws --validate --distro=arch --distro-version=2019-01-09
  depends_on:
  - clone

- name: CentOS 6
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-aws --validate --distro=centos --distro-version=6
  depends_on:
  - clone

- name: CentOS 7
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-aws --validate --distro=centos --distro-version=7
  depends_on:
  - clone

- name: Debian 8
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-aws --validate --distro=debian --distro-version=8
  depends_on:
  - clone

- name: Debian 9
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-aws --validate --distro=debian --distro-version=9
  depends_on:
  - clone

- name: Fedora 28
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-aws --validate --distro=fedora --distro-version=28
  depends_on:
  - clone

- name: Fedora 29
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-aws --validate --distro=fedora --distro-version=29
  depends_on:
  - clone

- name: Opensuse 15
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-aws --validate --distro=opensuse --distro-version=15
  depends_on:
  - clone

- name: Opensuse 42.3
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-aws --validate --distro=opensuse --distro-version=42.3
  depends_on:
  - clone

- name: Ubuntu 1404
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-aws --validate --distro=ubuntu --distro-version=1404
  depends_on:
  - clone

- name: Ubuntu 1604
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-aws --validate --distro=ubuntu --distro-version=1604
  depends_on:
  - clone

- name: Ubuntu 1804
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-aws --validate --distro=ubuntu --distro-version=1804
  depends_on:
  - clone

- name: Windows 2012r2
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-aws --validate --distro=windows --distro-version=2012r2
  depends_on:
  - clone

- name: Windows 2016
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-aws --validate --distro=windows --distro-version=2016
  depends_on:
  - clone

- name: Windows 2019
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-aws --validate --distro=windows --distro-version=2019
  depends_on:
  - clone

---
kind: pipeline
name: Lint Docker

platform:
  os: linux
  arch: amd64

steps:
- name: Arch
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-docker --validate --distro=arch --distro-version=2019-01-09
  depends_on:
  - clone

- name: CentOS 6
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-docker --validate --distro=centos --distro-version=6
  depends_on:
  - clone

- name: CentOS 7
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-docker --validate --distro=centos --distro-version=7
  depends_on:
  - clone

- name: Debian 8
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-docker --validate --distro=debian --distro-version=8
  depends_on:
  - clone

- name: Debian 9
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-docker --validate --distro=debian --distro-version=9
  depends_on:
  - clone

- name: Fedora 28
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-docker --validate --distro=fedora --distro-version=28
  depends_on:
  - clone

- name: Fedora 29
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-docker --validate --distro=fedora --distro-version=29
  depends_on:
  - clone

- name: Opensuse 15
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-docker --validate --distro=opensuse --distro-version=15
  depends_on:
  - clone

- name: Opensuse 42.3
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-docker --validate --distro=opensuse --distro-version=42.3
  depends_on:
  - clone

- name: Ubuntu 1404
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-docker --validate --distro=ubuntu --distro-version=1404
  depends_on:
  - clone

- name: Ubuntu 1604
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-docker --validate --distro=ubuntu --distro-version=1604
  depends_on:
  - clone

- name: Ubuntu 1804
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip
  - pip install invoke
  - inv build-docker --validate --distro=ubuntu --distro-version=1804
  depends_on:
  - clone

---
kind: pipeline
name: AWS Arch

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 7 seconds; sleep 7'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --distro=arch --distro-version=2019-01-09
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  event:
  - tag
  ref:
  - "refs/tags/aws-base-v1.*"

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS CentOS 6

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 14 seconds; sleep 14'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --distro=centos --distro-version=6
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  event:
  - tag
  ref:
  - "refs/tags/aws-base-v1.*"

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS CentOS 7

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 21 seconds; sleep 21'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --distro=centos --distro-version=7
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  event:
  - tag
  ref:
  - "refs/tags/aws-base-v1.*"

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Debian 8

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 28 seconds; sleep 28'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --distro=debian --distro-version=8
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  event:
  - tag
  ref:
  - "refs/tags/aws-base-v1.*"

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Debian 9

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 35 seconds; sleep 35'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --distro=debian --distro-version=9
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  event:
  - tag
  ref:
  - "refs/tags/aws-base-v1.*"

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Fedora 28

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 42 seconds; sleep 42'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --distro=fedora --distro-version=28
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  event:
  - tag
  ref:
  - "refs/tags/aws-base-v1.*"

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Fedora 29

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 49 seconds; sleep 49'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --distro=fedora --distro-version=29
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  event:
  - tag
  ref:
  - "refs/tags/aws-base-v1.*"

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Opensuse 15

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 56 seconds; sleep 56'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --distro=opensuse --distro-version=15
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  event:
  - tag
  ref:
  - "refs/tags/aws-base-v1.*"

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Opensuse 42.3

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 63 seconds; sleep 63'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --distro=opensuse --distro-version=42.3
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  event:
  - tag
  ref:
  - "refs/tags/aws-base-v1.*"

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Ubuntu 1404

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 70 seconds; sleep 70'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --distro=ubuntu --distro-version=1404
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  event:
  - tag
  ref:
  - "refs/tags/aws-base-v1.*"

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Ubuntu 1604

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 77 seconds; sleep 77'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --distro=ubuntu --distro-version=1604
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  event:
  - tag
  ref:
  - "refs/tags/aws-base-v1.*"

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Ubuntu 1804

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 84 seconds; sleep 84'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --distro=ubuntu --distro-version=1804
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  event:
  - tag
  ref:
  - "refs/tags/aws-base-v1.*"

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Windows 2012r2

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 0 seconds; sleep 0'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --distro=windows --distro-version=2012r2
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  event:
  - tag
  ref:
  - "refs/tags/aws-base-v1.*"

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Windows 2016

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 0 seconds; sleep 0'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --distro=windows --distro-version=2016
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  event:
  - tag
  ref:
  - "refs/tags/aws-base-v1.*"

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Windows 2019

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 0 seconds; sleep 0'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --distro=windows --distro-version=2019
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  event:
  - tag
  ref:
  - "refs/tags/aws-base-v1.*"

depends_on:
- Lint AWS

---
kind: pipeline
name: Docker Arch

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 7 seconds; sleep 7'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --distro=arch --distro-version=2019-01-09
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  event:
  - tag
  ref:
  - "refs/tags/docker-base-v1.*"

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker CentOS 6

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 14 seconds; sleep 14'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --distro=centos --distro-version=6
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  event:
  - tag
  ref:
  - "refs/tags/docker-base-v1.*"

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker CentOS 7

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 21 seconds; sleep 21'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --distro=centos --distro-version=7
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  event:
  - tag
  ref:
  - "refs/tags/docker-base-v1.*"

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Debian 8

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 28 seconds; sleep 28'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --distro=debian --distro-version=8
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  event:
  - tag
  ref:
  - "refs/tags/docker-base-v1.*"

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Debian 9

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 35 seconds; sleep 35'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --distro=debian --distro-version=9
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  event:
  - tag
  ref:
  - "refs/tags/docker-base-v1.*"

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Fedora 28

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 42 seconds; sleep 42'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --distro=fedora --distro-version=28
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  event:
  - tag
  ref:
  - "refs/tags/docker-base-v1.*"

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Fedora 29

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 49 seconds; sleep 49'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --distro=fedora --distro-version=29
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  event:
  - tag
  ref:
  - "refs/tags/docker-base-v1.*"

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Opensuse 15

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 56 seconds; sleep 56'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --distro=opensuse --distro-version=15
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  event:
  - tag
  ref:
  - "refs/tags/docker-base-v1.*"

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Opensuse 42.3

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 63 seconds; sleep 63'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --distro=opensuse --distro-version=42.3
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  event:
  - tag
  ref:
  - "refs/tags/docker-base-v1.*"

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Ubuntu 1404

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 70 seconds; sleep 70'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --distro=ubuntu --distro-version=1404
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  event:
  - tag
  ref:
  - "refs/tags/docker-base-v1.*"

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Ubuntu 1604

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 77 seconds; sleep 77'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --distro=ubuntu --distro-version=1604
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  event:
  - tag
  ref:
  - "refs/tags/docker-base-v1.*"

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Ubuntu 1804

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 84 seconds; sleep 84'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --distro=ubuntu --distro-version=1804
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  event:
  - tag
  ref:
  - "refs/tags/docker-base-v1.*"

depends_on:
- Lint Docker

---
kind: pipeline
name: AWS Arch (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 7 seconds; sleep 7'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --staging --distro=arch --distro-version=2019-01-09
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS CentOS 6 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 14 seconds; sleep 14'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --staging --distro=centos --distro-version=6
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS CentOS 7 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 21 seconds; sleep 21'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --staging --distro=centos --distro-version=7
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Debian 8 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 28 seconds; sleep 28'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --staging --distro=debian --distro-version=8
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Debian 9 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 35 seconds; sleep 35'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --staging --distro=debian --distro-version=9
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Fedora 28 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 42 seconds; sleep 42'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --staging --distro=fedora --distro-version=28
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Fedora 29 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 49 seconds; sleep 49'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --staging --distro=fedora --distro-version=29
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Opensuse 15 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 56 seconds; sleep 56'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --staging --distro=opensuse --distro-version=15
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Opensuse 42.3 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 63 seconds; sleep 63'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --staging --distro=opensuse --distro-version=42.3
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Ubuntu 1404 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 70 seconds; sleep 70'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --staging --distro=ubuntu --distro-version=1404
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Ubuntu 1604 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 77 seconds; sleep 77'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --staging --distro=ubuntu --distro-version=1604
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Ubuntu 1804 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 84 seconds; sleep 84'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --staging --distro=ubuntu --distro-version=1804
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Windows 2012r2 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 0 seconds; sleep 0'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --staging --distro=windows --distro-version=2012r2
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Windows 2016 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 0 seconds; sleep 0'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --staging --distro=windows --distro-version=2016
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint AWS

---
kind: pipeline
name: AWS Windows 2019 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 0 seconds; sleep 0'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - pip install invoke
  - inv build-aws --staging --distro=windows --distro-version=2019
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: username
    AWS_DEFAULT_REGION: us-west-2
    AWS_SECRET_ACCESS_KEY:
      from_secret: password
  depends_on:
  - throttle-build

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint AWS

---
kind: pipeline
name: Docker Arch (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 7 seconds; sleep 7'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --staging --distro=arch --distro-version=2019-01-09
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker CentOS 6 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 14 seconds; sleep 14'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --staging --distro=centos --distro-version=6
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker CentOS 7 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 21 seconds; sleep 21'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --staging --distro=centos --distro-version=7
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Debian 8 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 28 seconds; sleep 28'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --staging --distro=debian --distro-version=8
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Debian 9 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 35 seconds; sleep 35'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --staging --distro=debian --distro-version=9
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Fedora 28 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 42 seconds; sleep 42'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --staging --distro=fedora --distro-version=28
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Fedora 29 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 49 seconds; sleep 49'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --staging --distro=fedora --distro-version=29
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Opensuse 15 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 56 seconds; sleep 56'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --staging --distro=opensuse --distro-version=15
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Opensuse 42.3 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 63 seconds; sleep 63'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --staging --distro=opensuse --distro-version=42.3
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Ubuntu 1404 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 70 seconds; sleep 70'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --staging --distro=ubuntu --distro-version=1404
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Ubuntu 1604 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 77 seconds; sleep 77'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --staging --distro=ubuntu --distro-version=1604
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint Docker

---
kind: pipeline
name: Docker Ubuntu 1804 (Staging)

platform:
  os: linux
  arch: amd64

steps:
- name: throttle-build
  image: alpine
  commands:
  - "sh -c 'echo Sleeping 84 seconds; sleep 84'"

- name: base-image
  image: hashicorp/packer
  commands:
  - apk --no-cache add --update py-pip make curl grep gawk sed
  - apk --no-cache add --update docker
  - pip install invoke
  - inv build-docker --staging --distro=ubuntu --distro-version=1804
  environment:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  depends_on:
  - throttle-build

services:
- name: docker
  image: docker:edge-dind
  command:
  - --storage-driver=overlay2
  privileged: true

trigger:
  branch:
  - master
  event:
  - push
  - pull_request

depends_on:
- Lint Docker

---
kind: secret
type: general
data:
  docker_password: >
    dockerpassword
  docker_username: >
    dockerusername
  password: >
    ood6DhiPeWBKZfSOqhsq-iJPmkfnrbdIonynU7Hdd_gTk4eeii_l4cbit9O3
    s5P-iX3CWa_v6RwKtKz9vQd6V0MuphwGxRAcSC1z4O3R0g==
  username: >
    I0tTPep0OuH_qwx5v5-cr4gONWEDbccbJ4yShpI369wV5WYYRuq1Gckx40A6
    _OK_ypQ4AfAiDjEsC2U=

---
kind: signature
hmac: d37fafada027fb50e647c412f9ea1c4491fd845b80f4faa26328b3ccf161739c

...
